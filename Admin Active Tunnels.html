<!DOCTYPE html>
<html class="dark" lang="en">
<!-- THEME LOCK: Verified Dark Mode Tokens via CSS Variables -->

<head>
    <script>
        // Auth Guard - soft disabled for validation
        if (localStorage.getItem('userRole') !== 'admin') {
            // window.location.href = 'Login.html';
        }
    </script>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Active Projects - Admin | DISAL Hosting</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="assets/css/tokens.css" rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&amp;family=JetBrains+Mono:wght@400;500&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="assets/js/tailwind-config.js"></script>
    <script src="assets/js/theme-toggle.js"></script>
</head>

<body
    class="bg-background-dark text-text-main h-screen overflow-hidden flex font-display antialiased transition-colors duration-200">

    <!-- Side Navigation -->
    <aside
        class="dark hidden md:flex w-64 bg-sidebar border-r border-border-dark flex flex-col justify-between h-full shrink-0 z-20 relative transition-colors duration-200">
        <div class="flex flex-col gap-1 p-6">
            <div class="flex flex-col mb-8">
                <div onclick="window.location.href='index.html'"
                    class="flex items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity">
                    <div class="flex size-8 items-center justify-center rounded-lg bg-primary/10 text-primary">
                        <span class="material-symbols-outlined" style="font-size: 20px;">terminal</span>
                    </div>
                    <span class="text-lg font-bold tracking-tight text-text-main">DISAL</span>
                </div>
                <p class="text-text-dim text-xs mt-2">INFRA_CONTROLLER_V2</p>
            </div>
            <nav class="flex flex-col gap-1">
                <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-surface-dark group transition-colors"
                    href="Admin Dashboard.html">
                    <span class="material-symbols-outlined text-text-dim group-hover:text-text-main transition-colors"
                        style="font-size: 20px;">grid_view</span>
                    <span
                        class="text-text-dim group-hover:text-text-main text-sm font-medium transition-colors">Overview</span>
                </a>
                <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-surface-dark border-l-2 border-primary group transition-colors"
                    href="Admin Active Tunnels.html">
                    <span class="material-symbols-outlined text-primary" style="font-size: 20px;">cloud_sync</span>
                    <span class="text-text-main text-sm font-medium">Project List</span>
                </a>
                <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-surface-dark group transition-colors"
                    href="Audit Logs.html">
                    <span class="material-symbols-outlined text-text-dim group-hover:text-text-main transition-colors"
                        style="font-size: 20px;">article</span>
                    <span class="text-text-dim group-hover:text-text-main text-sm font-medium transition-colors">System
                        Alerts</span>
                </a>
                <div class="h-px bg-border-dark my-4"></div>
                <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-surface-dark group transition-colors"
                    href="Documentation.html">
                    <span class="material-symbols-outlined text-text-dim group-hover:text-text-main transition-colors"
                        style="font-size: 20px;">menu_book</span>
                    <span
                        class="text-text-dim group-hover:text-text-main text-sm font-medium transition-colors">Docs</span>
                </a>
            </nav>
        </div>
        <div class="p-4 border-t border-border-dark flex items-center justify-between">
            <div class="flex items-center gap-3 px-2">
                <div
                    class="size-8 rounded-full bg-surface-dark border border-border-dark flex items-center justify-center text-xs font-bold text-primary">
                    AD</div>
                <div class="flex flex-col">
                    <span class="text-text-main text-sm font-medium">Admin User</span>
                    <span class="text-text-dim text-xs">admin@disal.io</span>
                </div>
            </div>
            <!-- Theme Toggle -->
            <button onclick="toggleTheme()"
                class="p-2 rounded-lg hover:bg-surface-dark text-text-dim hover:text-text-main transition-colors"
                title="Toggle Theme">
                <span class="material-symbols-outlined dark:hidden">dark_mode</span>
                <span class="material-symbols-outlined hidden dark:block">light_mode</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main
        class="flex-1 flex flex-col h-full overflow-hidden bg-background-dark relative transition-colors duration-200">
        <!-- Strict Grid Pattern -->
        <!-- Grid Background Removed for cleaner utility view -->
        <!-- <div class="absolute inset-0 pointer-events-none bg-grid-pattern z-0"></div> -->

        <!-- Header -->
        <header
            class="h-16 border-b border-border-dark flex items-center justify-between px-4 md:px-8 bg-background-dark/80 backdrop-blur-md z-10 sticky top-0 transition-colors duration-200">
            <div class="flex items-center gap-4">
                <nav class="flex items-center text-sm font-medium text-text-dim">
                    <a class="hover:text-text-main transition-colors" href="Landing Page.html">Home</a>
                    <span class="mx-2 text-border-dark">/</span>
                    <a class="hover:text-text-main transition-colors" href="Admin Dashboard.html">Infrastructure</a>
                    <span class="mx-2 text-border-dark">/</span>
                    <span class="text-text-main">Active Projects</span>
                </nav>
            </div>
            <div class="flex items-center gap-4">
                <!-- Search Bar -->
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span
                            class="material-symbols-outlined text-text-dim group-focus-within:text-primary transition-colors text-[20px]">search</span>
                    </div>
                    <input
                        class="bg-surface-dark border border-border-dark text-text-main text-sm rounded-lg focus:ring-1 focus:ring-primary focus:border-primary block w-64 pl-10 p-2 placeholder-text-dim/50 transition-all font-display"
                        placeholder="Search apps..." type="text" />
                </div>
                <!-- Primary Action -->
                <button
                    class="flex items-center gap-2 bg-surface-dark hover:bg-background-dark border border-border-dark text-text-main px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    <span class="material-symbols-outlined text-[18px]">refresh</span>
                    Refresh List
                </button>
            </div>
        </header>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 scrollbar-hide relative z-10">
            <!-- Filter & View Controls -->
            <div class="flex flex-col gap-6 mb-6 lg:flex-row lg:items-start lg:justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-text-main mb-1">Global Active Projects</h1>
                    <p class="text-text-dim text-sm">Monitor all active application deployments across the
                        infrastructure.</p>
                </div>
                <!-- Port Allocation Manager (Admin "Vending Machine") -->
                <div
                    class="w-full max-w-md bg-surface-dark border border-border-dark rounded-default p-4 flex flex-col gap-3 shadow-lg shadow-black/20">
                    <div class="flex items-center justify-between gap-2">
                        <div class="flex flex-col gap-0.5">
                            <h2 class="text-sm font-semibold text-text-main">Port Allocation Manager</h2>
                            <p class="text-[11px] text-text-dim">Create student access and update TOML config.</p>
                        </div>
                        <span
                            class="px-2 py-0.5 rounded-full text-[10px] font-mono bg-primary/10 text-primary border border-primary/20">TOML
                            Source of Truth</span>
                    </div>
                    <form class="flex flex-col gap-3" onsubmit="handlePortAllocation(event)">
                        <div class="flex flex-col gap-1">
                            <label class="text-[11px] font-mono uppercase tracking-wider text-text-dim">Student ID</label>
                            <input id="allocStudentId" type="text" placeholder="e.g. 21005678"
                                class="w-full bg-background-dark border border-border-dark rounded-lg px-3 py-2 text-xs text-text-main placeholder-text-dim/60 focus:border-primary focus:ring-1 focus:ring-primary outline-none">
                        </div>
                        <div class="flex items-center gap-2 text-[11px] text-text-dim">
                            <span class="material-symbols-outlined text-[16px] text-text-dim">info</span>
                            <span>Port will be auto-assigned in the <span class="font-mono">9000â€‘9999</span> range.</span>
                        </div>
                        <div class="flex items-center justify-between gap-2">
                            <button type="button" onclick="handleServiceRestart()"
                                class="px-3 py-1.5 rounded-lg border border-border-dark bg-background-dark text-[11px] font-medium text-text-dim hover:text-text-main hover:bg-surface-dark transition-colors flex items-center gap-1.5">
                                <span class="material-symbols-outlined text-[16px]">restart_alt</span>
                                Service Restart
                            </button>
                            <button type="submit"
                                class="px-4 py-1.5 rounded-lg bg-primary text-[11px] font-bold text-white hover:bg-primary/90 transition-colors flex items-center gap-1.5">
                                <span class="material-symbols-outlined text-[16px]">add_link</span>
                                Create Student Access
                            </button>
                        </div>
                        <p id="allocStatus" class="text-[11px] text-success hidden">
                            Port allocated and TOML config updated. Student dashboard will now show assigned port.
                        </p>
                        <p id="restartStatus" class="text-[11px] text-info hidden">
                            FRP service restart triggered. New mappings are now active.
                        </p>
                    </form>
                </div>
            </div>

            <!-- TOML Config Preview -->
            <div
                class="mb-6 rounded-default border border-border-dark bg-surface-dark/60 p-4 font-mono text-[11px] text-text-dim">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-semibold text-text-main">toml_config/ports.toml</span>
                    <span id="tomlStatusBadge"
                        class="px-2 py-0.5 rounded-full text-[10px] border border-border-dark text-text-dim">No student
                        ports allocated</span>
                </div>
                <pre id="tomlPreview" class="whitespace-pre-wrap leading-relaxed text-[11px]">
[ports]
; student_id = "port"
; Entries will appear here after allocation.
                </pre>
            </div>

            <!-- Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                <!-- Card 1 -->
                <div
                    class="bg-surface-dark border border-border-dark rounded-default p-5 flex flex-col gap-4 hover:border-primary/50 transition-all group relative overflow-hidden shadow-lg shadow-black/20">
                    <div class="flex justify-between items-start">
                        <div class="flex flex-col gap-1">
                            <h3 class="font-bold text-text-main text-base">API Gateway - Port 8080</h3>
                            <span class="text-xs text-text-dim">User: student_8841</span>
                        </div>
                        <span
                            class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold bg-success/10 text-success border border-success/20">
                            <span class="w-1.5 h-1.5 rounded-full bg-success animate-pulse"></span>
                            Live
                        </span>
                    </div>
                    <div
                        class="bg-inset rounded border border-border-dark p-3 font-mono text-xs text-text-dim flex items-center justify-between group-hover:border-border-dark/80 transition-colors">
                        <div class="truncate flex items-center gap-2">http://api.tunnel.disal.io</div>
                        <button
                            class="text-text-dim hover:text-text-main transition-colors opacity-0 group-hover:opacity-100">
                            <span class="material-symbols-outlined text-[16px]">content_copy</span>
                        </button>
                    </div>
                    <div class="flex items-center justify-between pt-2 border-t border-border-dark mt-auto">
                        <div class="flex items-center gap-2 text-xs text-text-dim">
                            <span class="material-symbols-outlined text-[16px]">schedule</span>
                            Uptime: 4d 12h
                        </div>
                        <div class="flex gap-2">
                            <button
                                class="text-text-dim hover:text-red-400 transition-colors p-1 rounded hover:bg-red-400/10"
                                title="Force Stop">
                                <span class="material-symbols-outlined text-[18px]">power_settings_new</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Card 2 -->
                <div
                    class="bg-surface-dark border border-border-dark rounded-default p-5 flex flex-col gap-4 hover:border-primary/50 transition-all group relative overflow-hidden shadow-lg shadow-black/20">
                    <div class="flex justify-between items-start">
                        <div class="flex flex-col gap-1">
                            <h3 class="font-bold text-text-main text-base">React Frontend</h3>
                            <span class="text-xs text-text-dim">User: student_2022</span>
                        </div>
                        <span
                            class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold bg-success/10 text-success border border-success/20">
                            <span class="w-1.5 h-1.5 rounded-full bg-success animate-pulse"></span>
                            Live
                        </span>
                    </div>
                    <div
                        class="bg-inset rounded border border-border-dark p-3 font-mono text-xs text-text-dim flex items-center justify-between group-hover:border-border-dark/80 transition-colors">
                        <div class="truncate flex items-center gap-2">http://preview.disal.io/usr99</div>
                        <button
                            class="text-text-dim hover:text-text-main transition-colors opacity-0 group-hover:opacity-100">
                            <span class="material-symbols-outlined text-[16px]">content_copy</span>
                        </button>
                    </div>
                    <div class="flex items-center justify-between pt-2 border-t border-border-dark mt-auto">
                        <div class="flex items-center gap-2 text-xs text-text-dim">
                            <span class="material-symbols-outlined text-[16px]">schedule</span>
                            Uptime: 0h 45m
                        </div>
                        <div class="flex gap-2">
                            <button
                                class="text-text-dim hover:text-red-400 transition-colors p-1 rounded hover:bg-red-400/10"
                                title="Force Stop">
                                <span class="material-symbols-outlined text-[18px]">power_settings_new</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Card 3 -->
                <div
                    class="bg-surface-dark border border-border-dark rounded-default p-5 flex flex-col gap-4 hover:border-primary/50 transition-all group relative overflow-hidden shadow-lg shadow-black/20">
                    <div class="flex justify-between items-start">
                        <div class="flex flex-col gap-1">
                            <h3 class="font-bold text-text-main text-base">Postgres DB</h3>
                            <span class="text-xs text-text-dim">User: research_grp_A</span>
                        </div>
                        <span
                            class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold bg-warning/10 text-warning border border-warning/20">
                            <span class="w-1.5 h-1.5 rounded-full bg-warning"></span>
                            Idle
                        </span>
                    </div>
                    <div
                        class="bg-inset rounded border border-border-dark p-3 font-mono text-xs text-text-dim flex items-center justify-between group-hover:border-border-dark/80 transition-colors">
                        <div class="truncate flex items-center gap-2">http://db.tunnel.disal.io</div>
                        <button
                            class="text-text-dim hover:text-text-main transition-colors opacity-0 group-hover:opacity-100">
                            <span class="material-symbols-outlined text-[16px]">content_copy</span>
                        </button>
                    </div>
                    <div class="flex items-center justify-between pt-2 border-t border-border-dark mt-auto">
                        <div class="flex items-center gap-2 text-xs text-text-dim">
                            <span class="material-symbols-outlined text-[16px]">schedule</span>
                            Uptime: 2d 01h
                        </div>
                        <div class="flex gap-2">
                            <button
                                class="text-text-dim hover:text-red-400 transition-colors p-1 rounded hover:bg-red-400/10"
                                title="Force Stop">
                                <span class="material-symbols-outlined text-[18px]">power_settings_new</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        function handlePortAllocation(e) {
            e.preventDefault();
            const studentInput = document.getElementById('allocStudentId');
            const allocStatus = document.getElementById('allocStatus');
            const restartStatus = document.getElementById('restartStatus');
            const tomlPreview = document.getElementById('tomlPreview');
            const tomlStatusBadge = document.getElementById('tomlStatusBadge');

            const studentId = (studentInput.value || '').trim();
            if (!studentId) {
                alert('Please enter a valid Student ID before allocating a port.');
                return;
            }

            // Very simple deterministic mock port assignment based on studentId hash
            const basePort = 9000;
            let hash = 0;
            for (let i = 0; i < studentId.length; i++) {
                hash = (hash + studentId.charCodeAt(i)) % 1000;
            }
            const assignedPort = basePort + (hash || 1);

            // Persist entitlement for the student path (Student Dashboard)
            localStorage.setItem('hasPortEntitlement', 'true');
            localStorage.setItem('assignedPort', String(assignedPort));
            localStorage.setItem('entitledStudentId', studentId);

            // Update TOML-like preview buffer
            const existing = localStorage.getItem('tomlConfig');
            const header = '[ports]';
            let bodyLines = [];
            if (existing) {
                bodyLines = existing.split('\n').filter(Boolean);
            }

            // Ensure header present
            if (!bodyLines.includes(header)) {
                bodyLines.unshift(header);
            }

            const entry = `${studentId} = "${assignedPort}"`;
            const filtered = bodyLines.filter(line => !line.startsWith(studentId + ' ='));
            filtered.push(entry);
            const newConfig = filtered.join('\n');
            localStorage.setItem('tomlConfig', newConfig);

            if (tomlPreview) {
                tomlPreview.textContent = newConfig;
            }
            if (tomlStatusBadge) {
                tomlStatusBadge.textContent = 'Port allocation updated';
                tomlStatusBadge.classList.remove('text-text-dim');
                tomlStatusBadge.classList.add('text-success', 'border-success/40');
            }

            if (allocStatus) {
                allocStatus.classList.remove('hidden');
            }
            if (restartStatus) {
                restartStatus.classList.add('hidden');
            }
        }

        function handleServiceRestart() {
            const restartStatus = document.getElementById('restartStatus');
            localStorage.setItem('serviceRestarted', 'true');
            if (restartStatus) {
                restartStatus.classList.remove('hidden');
            }
            alert('Service Restart triggered. FRP will reload the TOML Config File.');
        }

        // Initialize TOML preview from localStorage on load
        (function initTomlPreview() {
            const tomlPreview = document.getElementById('tomlPreview');
            const tomlStatusBadge = document.getElementById('tomlStatusBadge');
            const stored = localStorage.getItem('tomlConfig');
            if (stored && tomlPreview) {
                tomlPreview.textContent = stored;
                if (tomlStatusBadge) {
                    tomlStatusBadge.textContent = 'Existing student port mappings loaded';
                    tomlStatusBadge.classList.remove('text-text-dim');
                    tomlStatusBadge.classList.add('text-success', 'border-success/40');
                }
            }
        })();
    </script>

</body>

</html>